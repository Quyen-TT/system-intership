# Tạo và quản lí máy ảo bằng giao dieenj CLI Virsh

## 1. Tạo máy ảo với Virsh

Sử dụng lệnh `virt-install` với các tham số, giá trị truyền vào để tạo máy ảo với thông tin cấu hình mong muốn. 

Hầu hết các options là không bắt buộc, `virt-install` chỉ yêu cầu 1 số thông tin tối thiểu sau

    --name
    --ram
    --disk
    --filesystem or --nodisks

Các tham số đối với virt-install:

- --name: đặt tên cho máy ảo
- --ram: set dung lượng RAM cho máy ảo (MB)
- --disk path = xx, size = xx: đường vẫn lưu file .img máy ảo và dung lượng disk mount
- --vspus: set giá trị số vCPU
- --os-type: kiểu hệ điều hành (linux, windows)
- --os-variant: kiểu của GuestOS
- --network: dải network mà máy ảo tạo ra sẽ cắm vào
- --graphics: set chế độ đồ họa, đặt là none -> không sử dụng chế độ đồ họa
- --console: lựa chọn kiểu console
- --location: đường dẫn tới file cài đặt
- --extra-args: set tham số cho kernel

### 1.1 Tạo VM bằng file iso

    sudo virt-install \
    --name=VM1 \
    --vcpus=1 \
    --memory=1024 \
    --cdrom=/var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-2009.iso \
    --disk path=/var/lib/libvirt/images/testVM1.img,size=10 \
    --os-variant=centos7.0 \
    --graphics vnc \
    --network network=default

![ảnh 20](/QuyenNV/14.KVM/images/anh20.png)

### 1.2 Tạo VM bằng file image

Có thể tạo máy ảo từ các disk image có sẵn, đã được cài hệ điều hành trước đó, có thể tải từ một số trang cung cấp cloud image như https://cloud-images.ubuntu.com/

Để tạo máy ảo từ image có sẵn, sử dụng câu lệnh sau:

    sudo virt-install \
    --name testVM2 \
    --ram 1024 \
    --vcpus 1 \
    --os-variant=ubuntu24.04 \
    --disk path=/var/lib/libvirt/boot/noble-minimal-cloudimg-amd64.img,size=10 \
    --network network=default \
    --hvm --virt-type kvm \
    --vnc --noautoconsole \
    --import

![ảnh 21](/QuyenNV/14.KVM/images/anh21.png)

## 2. Thao tác quản lý virt-manager

**Hiển thị danh sách máy ảo**

    virsh list --all

![ảnh 22](/QuyenNV/14.KVM/images/anh22.png)

**Bật máy ảo**

    virsh start <tên_máy_ảo>

![ảnh 23](/QuyenNV/14.KVM/images/anh23.png)

**Tắt máy ảo**

    virsh shutdown <tên_máy_ảo>

![ảnh 24](/QuyenNV/14.KVM/images/anh24.png)

**Reboot máy ảo**

    virsh reboot <tên_máy_ảo>

![ảnh 25](/QuyenNV/14.KVM/images/anh25.png)

**Xóa máy ảo**

    virsh undefine <tên_máy_ảo>

![ảnh 26](/QuyenNV/14.KVM/images/anh26.png)

**Tạo snapshot**

    virsh snapshot-create-as --domain tên_máy --name tên_bản_snapshot --description "mô tả bản snapshot"

![ảnh 27](/QuyenNV/14.KVM/images/anh27.png)

Lưu ý: snapshot chỉ tạo được khi định dạng disk ảo của ta sử dụng là qcow2 chính vì vậy nếu bạn đang sử dụng định dạng raw mà muốn tạo snapshot thì cần phải chuyển sang định dạng qcow2.

**Xem các bản snapshot của 1 VM**

    virsh snapshot-list <tên_máy_ảo>

![ảnh 28](/QuyenNV/14.KVM/images/anh28.png)

**Xem thông tin chi tiết của 1 bản snapshot**

    virsh snapshot-info --domain <tên_máy_ảo> --snapshotname <tên_bản_snapshot>

![ảnh 29](/QuyenNV/14.KVM/images/anh29.png)

**Revert lại bản snapshot đã tạo**

    virsh snapshot-revert <tên_máy_ảo> <tên-bản-snapshot>

![ảnh 30](/QuyenNV/14.KVM/images/anh30.png)

**Xóa 1 bản snapshot**

    virsh snapshot-delete --domain <tên_máy_ảo> --snapshotname <tên_bản_snapshot>

![ảnh 31](/QuyenNV/14.KVM/images/anh31.png)

**Sửa thông tin CPU hoặc Memory**

    virsh edit <tên_VM>

![ảnh 32](/QuyenNV/14.KVM/images/anh32.png)

**Xem thông tin chi tiết file disk của VM**

    qemu-img info <đường_dẫn_file-disk>

![ảnh 33](/QuyenNV/14.KVM/images/anh33.png)

**Xem thông tin cơ bản của 1 VM**

    virsh dominfo <tên_VM>

![ảnh 34](/QuyenNV/14.KVM/images/anh34.png)


