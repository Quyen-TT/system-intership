# Cách restore lại 1 VM trong trường hợp máy ảo bị chết

## I. Nguyên tắc restore VM

Khôi phục VM thực chất là tạo lại máy ảo từ dữ liệu đã có hoặc từ bản sao lưu.

Cái cần khôi phục thường bao gồm:

- File đĩa ảo (qcow2, raw).

- Cấu hình VM (XML trong libvirt).

- Snapshot (nếu có).

- Backup full (đĩa + cấu hình + metadata).

## II. Các cách restore VM

### 1. Restore khi còn nguyên file đĩa ảo

Trường hợp: VM bị xóa cấu hình (XML) nhưng file .qcow2 vẫn còn.

    virt-install \
    --name myvm_restore \
    --ram 2048 --vcpus 2 \
    --disk path=/var/lib/libvirt/images/myvm.qcow2,format=qcow2 \
    --import

`--import` để KVM không cài lại OS mà dùng trực tiếp đĩa cũ.

Hoặc nếu có file cấu hình XML backup:

    virsh define /path/to/vm.xml
    virsh start vm

### 2. Restore từ file XML + đĩa

Trường hợp: bạn có backup `vm.xml` và file đĩa `.qcow2`

    # Copy file đĩa vào thư mục libvirt
    cp vm.qcow2 /var/lib/libvirt/images/

    # Import lại XML
    virsh define vm.xml

    # Khởi động lại VM
    virsh start vm

Nếu đường dẫn đĩa thay đổi, mở `vm.xml` và sửa `<source file='/path/to/disk.qcow2'/>`

### 3. Restore từ snapshot

Trường hợp: VM bị lỗi nhưng vẫn còn snapshot.

Xem snapshot:

    virsh snapshot-list vm


Khôi phục snapshot:

    virsh snapshot-revert vm snapshot_name


Ghi đè snapshot làm trạng thái hiện tại:

    virsh snapshot-delete vm snapshot_name --metadata

### 4. Restore từ bản sao đĩa (copy)

Trường hợp: trước đó bạn có backup file đĩa bằng cp, rsync hoặc qemu-img.

    # Giải nén bản backup (nếu nén)
    tar -xvf myvm_backup.tar.gz -C /var/lib/libvirt/images/

    # Tạo lại VM từ file đĩa
    virt-install \
    --name myvm_restore \
    --ram 2048 --vcpus 2 \
    --disk path=/var/lib/libvirt/images/myvm.qcow2,format=qcow2 \
    --import