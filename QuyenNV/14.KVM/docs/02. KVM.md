# Tìm hiểu về KVM

## 1. KVM là gì?

KVM, viết tắt của Kernel Virtualization Machine, là một công nghệ ảo hóa phần cứng giới thiệu để hỗ trợ ảo hóa. Điều này có nghĩa là hệ điều hành chính (OS host) có nhiệm vụ mô phỏng phần cứng để cho phép các hệ điều hành khác (OS khách) chạy trên nền tảng ảo hóa này.

![KVM](/QuyenNV/14.KVM/images/KVM.png)

Chính vì vậy, KVM hoạt động như một người quản lý tài nguyên, giúp phân chia tài nguyên ổ đĩa, mạng và CPU một cách công bằng giữa các máy ảo. Đáng chú ý là công nghệ ảo hóa KVM là mã nguồn mở và đã được tích hợp vào hệ thống Linux như:

- Với công nghệ ảo hóa KVM, Linux có khả năng biến máy chủ thành một môi trường ảo, cho phép chạy nhiều máy khách hoặc máy ảo (Virtual Machine) được cô lập.

- KVM, là một phần của mã nguồn mở Linux, được tận dụng các tính năng của Linux, tức là nó cũng hưởng lợi từ tất cả các tính năng, sửa lỗi và các cập nhật mới của Linux mà không cần phải có kỹ thuật bổ sung.

- Ở môi trường ảo hóa KVM, tài nguyên không được chia sẻ vì chúng được cấu hình mặc định để không chia sẻ. Do đó, RAM của mỗi KVM được cấu hình sẵn cho mỗi gói VPS (Virtual Private Server), cho phép tận dụng 100% tài nguyên mà không cần chia sẻ. Điều này giúp máy chủ hoạt động ổn định hơn và không bị ảnh hưởng bởi các VPS khác trong cùng hệ thống. Tương tự, việc phân chia tài nguyên ổ cứng cũng được cấu hình tương tự như RAM.

### 2. KVM thuộc loại ảo hóa nào?

KVM (Kernel-based Virtual Machine) thuộc loại ảo hóa Type 1 Hypervisor (hoặc bare-metal hypervisor).

Mặc dù KVM là một module của nhân Linux, nhưng nó hoạt động như một hypervisor Type 1 vì những lý do sau:

- Tích hợp trực tiếp vào kernel Linux: KVM là một module của nhân Linux, không phải ứng dụng chạy trên OS host. Khi KVM được kích hoạt, Linux kernel trở thành hypervisor, hoạt động tương tự ESXi hay Hyper-V bare-metal.

- Truy cập trực tiếp phần cứng (hardware virtualization): KVM sử dụng VT-x (Intel) hoặc AMD-V (AMD) để cho phép VM chạy lệnh CPU trực tiếp trên phần cứng, không qua lớp OS trung gian như Type-2 hypervisor.

- VM chạy như tiến trình Linux nhưng được cô lập hoàn toàn: Mỗi VM là một tiến trình trong Linux, tận dụng bộ lập lịch (scheduler), quản lý bộ nhớ và driver thiết bị của kernel, đảm bảo hiệu suất cao và cách ly tốt.

- Kết hợp QEMU để giả lập thiết bị (I/O virtualization): KVM cung cấp ảo hóa CPU/memory, QEMU giả lập các thiết bị phần cứng (BIOS, NIC, VGA…) tạo thành giải pháp ảo hóa đầy đủ.

### 3. So sánh KVM với các hypervisor khác

| **Tiêu chí** | **KVM** | **VMware ESXi** | **Microsoft Hyper-V** | **VirtualBox** |
|--------------|---------|-----------------|-----------------------|----------------|
| **Loại hypervisor** | Type-1 (kernel-based) | Type-1 (bare-metal) | Type-1 (bare-metal) hoặc Type-2 (Windows host) | Type-2 (hosted) |
| **Cách cài đặt** | Module tích hợp trong Linux kernel | HĐH riêng (ESXi OS) | Cài như role trên Windows Server (Type-1) hoặc app Windows (Type-2) | Cài như phần mềm trên Windows/Linux/Mac |
| **OS host** | Linux (kernel = hypervisor) | Không có OS host, ESXi tự là OS | Windows Server hoặc Windows 10/11 Pro | Windows, Linux, MacOS |
| **Quản lý VM** | virsh, virt-manager, libvirt, OpenStack | vSphere Client, vCenter | Hyper-V Manager, SCVMM | GUI VirtualBox |
| **Chi phí** | Miễn phí, open-source | Mất phí (license cao) | Miễn phí (basic Hyper-V) + phí Windows license | Miễn phí |
| **Hiệu năng** | Gần native (tốt) | Rất cao (được tối ưu riêng) | Cao | Thấp – Trung bình |
| **Hỗ trợ guest OS** | Linux, Windows, BSD | Linux, Windows, BSD, macOS (hạn chế) | Windows, Linux | Linux, Windows, BSD, macOS |
| **Ứng dụng chính** | Datacenter Linux, Cloud (OpenStack), hosting | Datacenter doanh nghiệp lớn, ảo hóa server | Doanh nghiệp dùng Windows Server, datacenter | Học tập, lab, dev local |
| **Yêu cầu phần cứng** | CPU hỗ trợ VT-x hoặc AMD-V | CPU hỗ trợ VT-x hoặc AMD-V | CPU hỗ trợ SLAT (Intel EPT/AMD RVI) | Không yêu cầu đặc biệt (nhưng hỗ trợ VT-x tăng hiệu năng) |
| **Tính năng nổi bật** | Tích hợp kernel, dễ mở rộng cloud, open-source | Hiệu năng cực cao, tính năng vMotion, HA, DRS | Tích hợp Active Directory, Replica, Cluster | Dễ dùng, GUI trực quan, snapshot nhanh |
| **Khả năng mở rộng** | Rất cao (cloud-native, OpenStack) | Rất cao (datacenter lớn) | Cao (Windows ecosystem) | Thấp – chỉ phù hợp lab/dev |
| **Bản chất hypervisor** | Kernel module biến Linux thành hypervisor | Hệ điều hành riêng của VMware | Role trong Windows kernel (Type-1) hoặc app (Type-2) | Phần mềm giả lập chạy trên OS host |

## 4. Các thành phần trong KVM

![ảnh 7](/QuyenNV/14.KVM/images/anh7.png)

### 4.1 User-facing tools

Là các công cụ mà người dùng trực tiếp sử dụng để quản lý máy ảo trên KVM.

- virt-manager: giao diện đồ họa (GUI) giúp tạo, khởi động, tắt, snapshot và cấu hình máy ảo dễ dàng.

- virsh: công cụ dòng lệnh (CLI) mạnh mẽ, hỗ trợ gần như toàn bộ chức năng quản lý máy ảo thông qua libvirt.

- virt-tools: tập hợp các công cụ hỗ trợ bổ sung cho việc quản lý, cài đặt và cấu hình máy ảo (bao gồm virt-install, virt-clone…).

Các công cụ này không tương tác trực tiếp với KVM mà sẽ gửi yêu cầu đến libvirt để thực hiện thao tác quản lý VM.

### 4.2 Management layer

Lớp quản lý bao gồm thư viện libvirt và daemon libvirtd, cung cấp API chuẩn để các công cụ user-facing tools có thể giao tiếp với hypervisor.

Chức năng:

- Quản lý vòng đời máy ảo: tạo, start, stop, pause, resume, snapshot.

- Quản lý storage pool, network pool.

- Cung cấp API đa ngôn ngữ (C, Python, Go) cho lập trình và tích hợp hệ thống.

KVM chỉ cung cấp khả năng ảo hóa CPU và memory, không có chức năng quản lý VM, vì vậy libvirt đóng vai trò lớp quản lý trung gian, orchestrator giữa user tools và hypervisor.

### 4.3 Virtual machine

Máy ảo (Virtual Machine) là hệ điều hành khách (guest OS) mà người dùng tạo ra và vận hành trên hạ tầng ảo hóa KVM.

- Nếu không sử dụng các công cụ như virsh hay virt-manager, KVM sẽ được phối hợp với QEMU. QEMU đảm nhiệm việc giả lập phần cứng (CPU, disk, NIC, USB), còn KVM cung cấp cơ chế tăng tốc ảo hóa CPU/memory bằng phần cứng VT-x hoặc AMD-V.

- Mỗi VM thực chất là một tiến trình user-space trên Linux, chạy dưới dạng qemu-kvm process, nhưng có tài nguyên riêng biệt và được KVM cô lập, đảm bảo an toàn.

VM hoạt động dựa trên qemu-kvm: QEMU giả lập phần cứng máy ảo, KVM tăng tốc xử lý lệnh CPU để đạt hiệu năng gần native.

### 4.4 Kernel support

Lớp hỗ trợ trong kernel Linux cho phép KVM hoạt động như một hypervisor.

Thành phần chính:

- kvm.ko: module kernel chính, cung cấp hạ tầng ảo hóa cơ bản, xử lý tạo vCPU, context switching giữa guest và host.

- kvm-intel.ko / kvm-amd.ko: module kernel đặc thù cho CPU Intel hoặc AMD, hỗ trợ tập lệnh VT-x (Intel) hoặc AMD-V (AMD) để thực thi ảo hóa phần cứng.

Kernel support là nền tảng để KVM hoạt động, biến Linux kernel thành hypervisor Type-1 thực sự, cho phép VM thực thi lệnh CPU trực tiếp trên phần cứng với mức độ bảo mật và hiệu năng cao.

## 5. KVM hoạt động như thế nào?

Máy ảo sử dụng nhân (KVM) đòi hỏi cài đặt nhân Linux trên thiết bị sử dụng CPU hỗ trợ các phần mở rộng ảo hóa. Đặc biệt, KVM hỗ trợ tất cả các CPU x86, đó là loại chip máy tính có khả năng xử lý ngôn ngữ lệnh x86 từ Intel.

### 5.1 Nhân Linux

Nhân Linux là trái tim của hệ điều hành nguồn mở này. Nó đóng vai trò quan trọng trong việc tương tác với phần cứng của máy tính và đảm bảo rằng các ứng dụng phần mềm chạy trên hệ điều hành nhận được tài nguyên tính toán một cách hiệu quả. Các bản phân phối Linux như Red Hat Enterprise Linux, Fedora và Ubuntu kết hợp nhân Linux với các chương trình bổ sung để tạo ra một hệ điều hành thân thiện với người dùng.

### 5.2 Cách bật KVM

Để kích hoạt KVM sau khi đã cài đặt nhân Linux, người dùng cần cài đặt các thành phần phần mềm bổ sung sau trên máy Linux:

- Một module nhân máy chủ

- Một module tương thích với bộ xử lý

- Một trình giả lập

- Nhiều gói mở rộng của Linux để nâng cao khả năng và hiệu suất của KVM

Sau khi cài đặt, quản trị viên máy chủ sẽ tạo ra một máy ảo thông qua giao diện dòng lệnh hoặc giao diện người dùng đồ họa. Khi đó, KVM sẽ khởi chạy máy ảo này như một quy trình Linux độc lập. Phần mềm giám sát máy ảo sẽ quản lý việc phân bổ bộ nhớ, dung lượng lưu trữ, mạng, CPU và tài nguyên ảo cho từng máy ảo cụ thể.

## 6. Mối quan hệ của KVM với hệ điều hành (OS)

### 6.1 Vị trí của KVM trong OS

KVM không phải là một phần mềm riêng biệt chạy trên hệ điều hành như các hypervisor Type-2 (ví dụ VirtualBox). Thay vào đó, KVM là một module trong nhân (kernel) của Linux. Khi module KVM được tải, nó mở rộng chức năng của kernel để kernel Linux trở thành một hypervisor.

### 6.2 Cách KVM hoạt động với OS

Linux kernel đóng vai trò hypervisor:

- Khi KVM được kích hoạt, kernel Linux không chỉ hoạt động như hệ điều hành thông thường mà còn đóng vai trò hypervisor, trực tiếp quản lý và cấp phát tài nguyên phần cứng cho các máy ảo.

Máy ảo là tiến trình user-space:

- Mỗi VM chạy như một tiến trình (process) trong không gian người dùng (user-space) của Linux. Các tiến trình này do QEMU khởi tạo và quản lý. Tuy nhiên, khi máy ảo thực thi các lệnh CPU, KVM module trong kernel sẽ xử lý và chuyển lệnh này trực tiếp xuống CPU thật thông qua VT-x (Intel) hoặc AMD-V (AMD).

### 6.3 Ưu điểm của mối quan hệ này

Tận dụng kernel Linux: 

- Vì KVM tích hợp vào kernel, nó thừa hưởng toàn bộ cơ chế quản lý tài nguyên, lập lịch tiến trình, bảo mật, driver phần cứng của Linux, giúp giảm chi phí phát triển và tối ưu hiệu suất.

Cách tiếp cận Type-1 hypervisor: 

- Mặc dù KVM cần hệ điều hành Linux, nhưng bản thân kernel Linux + KVM module cùng nhau tạo thành hypervisor Type-1, vì chúng chạy trực tiếp trên phần cứng, không có lớp OS host trung gian như hypervisor Type-2.

### 6.4 Mô hình kiến trúc thể hiện mối quan hệ

![ảnh 8](/QuyenNV/14.KVM/images/anh8.png)
