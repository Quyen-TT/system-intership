# TÃ¬m hiá»ƒu cÃ¡c Ä‘á»‹nh dáº¡ng file images

## 1. CÆ¡ cháº¿ lÆ°u trá»¯ Thin-Thick

### 1.1 Thick Provisioning

Thick Provisioning lÃ  má»™t phÆ°Æ¡ng phÃ¡p quáº£n lÃ½ dung lÆ°á»£ng lÆ°u trá»¯ trong Ä‘Ã³ má»™t lÆ°á»£ng khÃ´ng gian Ä‘Ä©a cá»‘ Ä‘á»‹nh Ä‘Æ°á»£c cáº¥p phÃ¡t sáºµn cho má»™t á»• Ä‘Ä©a áº£o hoáº·c má»™t táº­p dá»¯ liá»‡u ngay tá»« Ä‘áº§u. Dung lÆ°á»£ng nÃ y Ä‘Æ°á»£c dÃ nh riÃªng cho á»• Ä‘Ä©a Ä‘Ã³, báº¥t ká»ƒ dá»¯ liá»‡u thá»±c táº¿ Ä‘Æ°á»£c lÆ°u trá»¯ lÃ  bao nhiÃªu. 

CÃ³ hai biáº¿n thá»ƒ chÃ­nh cá»§a phÆ°Æ¡ng phÃ¡p nÃ y:

- Eager Zeroed Thick Provisioning (Cáº¥p phÃ¡t dÃ y, ghi sá»‘ 0 ngay)

    - Ká»¹ thuáº­t nÃ y khÃ´ng chá»‰ cáº¥p phÃ¡t khÃ´ng gian lÆ°u trá»¯ trÆ°á»›c mÃ  cÃ²n ghi sá»‘ 0 vÃ o toÃ n bá»™ vÃ¹ng dung lÆ°á»£ng Ä‘Ã£ cáº¥p phÃ¡t ngay láº­p tá»©c.

    - Viá»‡c ghi sá»‘ 0 nÃ y Ä‘áº£m báº£o ráº±ng má»i dá»¯ liá»‡u cÅ© cÃ²n sÃ³t láº¡i Ä‘á»u bá»‹ xÃ³a sáº¡ch, táº¡o ra má»™t "trang tráº¯ng" Ä‘á»ƒ ghi dá»¯ liá»‡u má»›i.

    - Äiá»u nÃ y Ä‘áº·c biá»‡t quan trá»ng trong cÃ¡c mÃ´i trÆ°á»ng yÃªu cáº§u tÃ­nh toÃ n váº¹n vÃ  báº£o máº­t dá»¯ liá»‡u cao, vÃ¬ nÃ³ loáº¡i bá» kháº£ nÄƒng truy cáº­p vÃ o dá»¯ liá»‡u cÅ© cÃ²n sÃ³t láº¡i.

    - NgoÃ i ra, viá»‡c ghi sá»‘ 0 tá»« trÆ°á»›c cÃ²n giÃºp tÄƒng hiá»‡u nÄƒng ghi cho cÃ¡c á»©ng dá»¥ng ghi dá»¯ liá»‡u nhiá»u, vÃ¬ khÃ´ng cÃ²n pháº£i thá»±c hiá»‡n bÆ°á»›c lÃ m sáº¡ch trong quÃ¡ trÃ¬nh ghi sau nÃ y.

- Lazy Zeroed Thick Provisioning (Cáº¥p phÃ¡t dÃ y, ghi sá»‘ 0 khi cáº§n)

    - NgÆ°á»£c láº¡i vá»›i eager, lazy zeroed provisioning cÅ©ng cáº¥p phÃ¡t khÃ´ng gian Ä‘Ä©a trÆ°á»›c, nhÆ°ng khÃ´ng ghi sá»‘ 0 ngay láº­p tá»©c.

    - KhÃ´ng gian Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  Ä‘Ã£ cáº¥p phÃ¡t vÃ  sáº½ Ä‘Æ°á»£c ghi sá»‘ 0 khi cáº§n, tá»©c lÃ  trong lÃºc cÃ³ dá»¯ liá»‡u Ä‘Æ°á»£c ghi vÃ o.

    - CÃ¡ch nÃ y giÃºp rÃºt ngáº¯n thá»i gian cáº¥p phÃ¡t ban Ä‘áº§u, vÃ¬ nÃ³ bá» qua bÆ°á»›c ghi sá»‘ 0 trÆ°á»›c.

    - Tuy nhiÃªn, hiá»‡u nÄƒng ghi cÃ³ thá»ƒ bá»‹ áº£nh hÆ°á»Ÿng láº§n Ä‘áº§u tiÃªn má»—i vÃ¹ng Ä‘Ä©a Ä‘Æ°á»£c ghi, vÃ¬ há»‡ thá»‘ng cáº§n pháº£i ghi sá»‘ 0 trÆ°á»›c rá»“i má»›i ghi dá»¯ liá»‡u, Ä‘iá»u nÃ y cÃ³ thá»ƒ gÃ¢y ra Ä‘á»™ trá»… trong cÃ¡c á»©ng dá»¥ng cáº§n tá»‘c Ä‘á»™ ghi cao ngay láº­p tá»©c.

![áº£nh 13](/QuyenNV/14.KVM/images/anh13.png)

### 1.2 Thin Provisioning

Thin Provisioning lÃ  má»™t phÆ°Æ¡ng phÃ¡p cáº¥p phÃ¡t dung lÆ°á»£ng lÆ°u trá»¯ má»™t cÃ¡ch linh hoáº¡t vÃ  Ä‘á»™ng, Ä‘á»‘i láº­p hoÃ n toÃ n vá»›i Thick Provisioning. Thay vÃ¬ cáº¥p phÃ¡t toÃ n bá»™ dung lÆ°á»£ng Ä‘Ä©a tá»« Ä‘áº§u, Thin Provisioning chá»‰ cáº¥p phÃ¡t khÃ´ng gian khi thá»±c sá»± cáº§n thiáº¿t Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u.

CÃ¡ch tiáº¿p cáº­n nÃ y liÃªn quan Ä‘áº¿n viá»‡c táº¡o ra má»™t vÃ¹ng lÆ°u trá»¯ áº£o (virtual storage pool) mÃ  Ä‘á»‘i vá»›i há»‡ Ä‘iá»u hÃ nh vÃ  á»©ng dá»¥ng thÃ¬ cÃ³ váº» nhÆ° cÃ³ sáºµn má»™t khá»‘i lÆ°á»£ng lá»›n dung lÆ°á»£ng Ä‘Ä©a, dÃ¹ thá»±c táº¿ khÃ´ng gian váº­t lÃ½ hiá»‡n cÃ³ cÃ³ thá»ƒ nhá» hÆ¡n nhiá»u.

CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng:

- Khi nhu cáº§u lÆ°u trá»¯ dá»¯ liá»‡u tÄƒng lÃªn, Thin Provisioning sáº½ cáº¥p phÃ¡t thÃªm dung lÆ°á»£ng má»™t cÃ¡ch tá»± Ä‘á»™ng tá»« vÃ¹ng lÆ°u trá»¯ chung (storage pool) cho á»• Ä‘Ä©a áº£o.

- Viá»‡c cáº¥p phÃ¡t nÃ y tiáº¿p tá»¥c diá»…n ra cho Ä‘áº¿n khi Ä‘áº¡t Ä‘áº¿n giá»›i háº¡n tá»‘i Ä‘a Ä‘Ã£ Ä‘á»‹nh nghÄ©a.

![áº£nh 14](/QuyenNV/14.KVM/images/anh14.png)

## 2. Äá»‹nh dáº¡ng á»• Ä‘Ä©a ISO, RAW vÃ  QCOW2 trong KVM

### 2.1 ISO (International Standards Organization Disk Image)

ISO lÃ  má»™t Ä‘á»‹nh dáº¡ng áº£nh Ä‘Ä©a quang tiÃªu chuáº©n, chá»©a toÃ n bá»™ ná»™i dung cá»§a má»™t Ä‘Ä©a CD/DVD, bao gá»“m há»‡ thá»‘ng táº­p tin vÃ  dá»¯ liá»‡u nhá»‹ phÃ¢n.

Äáº·c Ä‘iá»ƒm ká»¹ thuáº­t:

- LÃ  Ä‘á»‹nh dáº¡ng chá»‰ Ä‘á»c (read-only).

- KhÃ´ng thá»ƒ ghi thÃªm dá»¯ liá»‡u vÃ o file ISO.

- KÃ­ch thÆ°á»›c cá»‘ Ä‘á»‹nh, pháº£n Ã¡nh ná»™i dung bÃªn trong.

- KhÃ´ng thá»ƒ dÃ¹ng Ä‘á»ƒ khá»Ÿi Ä‘á»™ng há»‡ Ä‘iá»u hÃ nh lÃ¢u dÃ i (non-persistent).

á»¨ng dá»¥ng trong KVM:

- ÄÆ°á»£c sá»­ dá»¥ng nhÆ° má»™t Ä‘Ä©a cÃ i Ä‘áº·t há»‡ Ä‘iá»u hÃ nh (bootable installation media).

- ThÆ°á»ng Ä‘Æ°á»£c gáº¯n vÃ o mÃ¡y áº£o nhÆ° má»™t á»• DVD áº£o Ä‘á»ƒ tiáº¿n hÃ nh cÃ i Ä‘áº·t cÃ¡c há»‡ Ä‘iá»u hÃ nh nhÆ° Ubuntu, CentOS, Windows, v.v.

- CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ chá»©a bá»™ cÃ i Ä‘áº·t pháº§n má»m chuyÃªn dá»¥ng.

### 2.2 RAW (Raw Disk Image)

RAW lÃ  Ä‘á»‹nh dáº¡ng áº£nh Ä‘Ä©a Ä‘Æ¡n giáº£n nháº¥t, ghi dá»¯ liá»‡u nhá»‹ phÃ¢n trá»±c tiáº¿p, khÃ´ng nÃ©n, khÃ´ng chá»©a metadata. File RAW pháº£n Ã¡nh Ä‘Ãºng cáº¥u trÃºc vÃ  dung lÆ°á»£ng cá»§a má»™t thiáº¿t bá»‹ lÆ°u trá»¯ váº­t lÃ½.

Äáº·c Ä‘iá»ƒm ká»¹ thuáº­t:

- KhÃ´ng há»— trá»£ snapshot hoáº·c cÃ¡c tÃ­nh nÄƒng nÃ¢ng cao.

- Cáº¥p phÃ¡t dÃ y (thick provisioning): khi táº¡o file RAW cÃ³ kÃ­ch thÆ°á»›c 20 GB, nÃ³ chiáº¿m Ä‘Ãºng 20 GB trÃªn Ä‘Ä©a, ngay cáº£ khi chá»‰ má»›i sá»­ dá»¥ng 1 GB.

- TÆ°Æ¡ng thÃ­ch cao vá»›i cÃ¡c há»‡ thá»‘ng lÆ°u trá»¯, pháº§n má»m backup vÃ  cÃ´ng cá»¥ xá»­ lÃ½ block-level.

Æ¯u Ä‘iá»ƒm:

- Hiá»‡u nÄƒng I/O cao, phÃ¹ há»£p vá»›i workload náº·ng.

- ÄÆ¡n giáº£n, khÃ´ng cÃ³ chi phÃ­ quáº£n lÃ½ metadata.

- PhÃ¹ há»£p vá»›i cÃ¡c há»‡ thá»‘ng lÆ°u trá»¯ cáº¥p tháº¥p nhÆ° LVM, iSCSI, ZFS,...

Háº¡n cháº¿:

- Tá»‘n dung lÆ°á»£ng lÆ°u trá»¯, ngay cáº£ khi chÆ°a sá»­ dá»¥ng háº¿t.

- KhÃ´ng há»— trá»£ cÃ¡c tÃ­nh nÄƒng nhÆ° snapshot, nÃ©n, mÃ£ hÃ³a.

á»¨ng dá»¥ng trong KVM:

- Sá»­ dá»¥ng trong cÃ¡c mÃ´i trÆ°á»ng sáº£n xuáº¥t (production), nÆ¡i hiá»‡u suáº¥t vÃ  Ä‘á»™ tin cáº­y Ä‘Æ°á»£c Æ°u tiÃªn hÃ ng Ä‘áº§u.

- Khi tÃ­ch há»£p vá»›i cÃ¡c giáº£i phÃ¡p lÆ°u trá»¯ váº­t lÃ½, há»‡ thá»‘ng sao lÆ°u block-level hoáº·c khi dÃ¹ng chung vá»›i container/VM hybrid.

### 2.3 QCOW2 (QEMU Copy-On-Write Version 2)

QCOW2 lÃ  Ä‘á»‹nh dáº¡ng áº£nh Ä‘Ä©a tiÃªn tiáº¿n do QEMU phÃ¡t triá»ƒn, há»— trá»£ nhiá»u tÃ­nh nÄƒng má»Ÿ rá»™ng nháº±m Ä‘Ã¡p á»©ng nhu cáº§u lÆ°u trá»¯ hiá»‡n Ä‘áº¡i cho mÃ¡y áº£o.

Äáº·c Ä‘iá»ƒm ká»¹ thuáº­t:

- Há»— trá»£ copy-on-write, giÃºp giá»¯ láº¡i cÃ¡c tráº¡ng thÃ¡i trÆ°á»›c Ä‘Ã³ (cÆ¡ sá»Ÿ cho snapshot).

- Thin provisioning: dung lÆ°á»£ng file tÄƒng dáº§n theo dá»¯ liá»‡u Ä‘Æ°á»£c ghi thá»±c táº¿.

Há»— trá»£ cÃ¡c tÃ­nh nÄƒng:

- Snapshot (táº¡o cÃ¡c Ä‘iá»ƒm khÃ´i phá»¥c tráº¡ng thÃ¡i mÃ¡y áº£o).

- NÃ©n dá»¯ liá»‡u (compression) Ä‘á»ƒ giáº£m dung lÆ°á»£ng lÆ°u trá»¯.

- MÃ£ hÃ³a (encryption) nháº±m tÄƒng cÆ°á»ng báº£o máº­t.

- Backing file (táº¡o file base vÃ  cÃ¡c báº£n ghi Ä‘Ã¨).

Æ¯u Ä‘iá»ƒm:

- Linh hoáº¡t, dá»… quáº£n lÃ½ vÃ  tiáº¿t kiá»‡m tÃ i nguyÃªn.

- Cho phÃ©p sá»­ dá»¥ng nhiá»u snapshot vÃ  khÃ´i phá»¥c tráº¡ng thÃ¡i há»‡ thá»‘ng nhanh chÃ³ng.

- PhÃ¹ há»£p trong mÃ´i trÆ°á»ng phÃ¡t triá»ƒn, thá»­ nghiá»‡m, giáº£ng dáº¡y hoáº·c demo.

Háº¡n cháº¿:

- Hiá»‡u nÄƒng cÃ³ thá»ƒ tháº¥p hÆ¡n so vá»›i RAW do pháº£i xá»­ lÃ½ metadata.

- CÃ³ nguy cÆ¡ phÃ¢n máº£nh náº¿u sá»­ dá»¥ng snapshot nhiá»u láº§n vÃ  khÃ´ng tá»‘i Æ°u.

á»¨ng dá»¥ng trong KVM:

- MÃ´i trÆ°á»ng thá»­ nghiá»‡m, lab áº£o hÃ³a, phÃ¡t triá»ƒn pháº§n má»m.

- Khi cáº§n khÃ´i phá»¥c tráº¡ng thÃ¡i nhanh, quáº£n lÃ½ nhiá»u phiÃªn báº£n mÃ¡y áº£o, hoáº·c chia sáº» máº«u cáº¥u hÃ¬nh.

## 3. So sÃ¡nh RAW vá»›i QCOW2

## ğŸ” So sÃ¡nh RAW vÃ  QCOW2

| **TiÃªu chÃ­**     | **RAW**                                                                 | **QCOW2**                                                                 |
|------------------|-------------------------------------------------------------------------|---------------------------------------------------------------------------|
| **Dung lÆ°á»£ng**   | Thick provisioning: chiáº¿m toÃ n bá»™ dung lÆ°á»£ng ngay khi táº¡o. | Thin provisioning: dung lÆ°á»£ng thá»±c táº¿ tÄƒng dáº§n theo dá»¯ liá»‡u. |
| **Hiá»‡u nÄƒng**    | Hiá»‡u nÄƒng cao: truy cáº­p trá»±c tiáº¿p khÃ´ng qua lá»›p metadata trung gian.   | Hiá»‡u nÄƒng tháº¥p hÆ¡n do xá»­ lÃ½ metadata, snapshot, copy-on-write.           |
| **Snapshot**     | KhÃ´ng há»— trá»£ snapshot ná»™i táº¡i.                                          | Há»— trá»£ snapshot máº¡nh máº½, cho phÃ©p lÆ°u tráº¡ng thÃ¡i vÃ  khÃ´i phá»¥c nhanh chÃ³ng. |
| **Há»— trá»£ nÃ©n / mÃ£ hÃ³a** | KhÃ´ng há»— trá»£.                                                    | CÃ³ há»— trá»£ nÃ©n vÃ  mÃ£ hÃ³a ná»™i dung.                                        |
| **TÆ°Æ¡ng thÃ­ch**  | TÆ°Æ¡ng thÃ­ch cao vá»›i pháº§n má»m/thiáº¿t bá»‹ quáº£n lÃ½ Ä‘Ä©a cáº¥p tháº¥p (LVM, dd...). | Tá»‘i Æ°u cho mÃ´i trÆ°á»ng áº£o hÃ³a sá»­ dá»¥ng KVM/QEMU.                           |
| **á»¨ng dá»¥ng phÃ¹ há»£p** | MÃ´i trÆ°á»ng sáº£n xuáº¥t, yÃªu cáº§u hiá»‡u nÄƒng cao.                         | PhÃ¡t triá»ƒn, thá»­ nghiá»‡m, nhiá»u snapshot vÃ  cáº§n tiáº¿t kiá»‡m dung lÆ°á»£ng.      |

### 3.1 Dung lÆ°á»£ng

Sá»­ dá»¥ng cÃ¢u lá»‡nh `qemu-img` Ä‘á»ƒ táº¡o ra má»™t file cÃ³ Ä‘á»‹nh dáº¡ng raw vÃ  má»™t file cÃ³ Ä‘á»‹nh dáº¡ng qcow2 Ä‘á»u cÃ³ dung lÆ°á»£ng lÃ  2G Ä‘á»ƒ tiáº¿n hÃ nh so sÃ¡nh.

File raw:

    qemu-img create -f raw file.raw 2G

File qcow2:

    qemu-img create -f qcow2 file.qcow2 2G

![áº£nh 15](/QuyenNV/14.KVM/images/anh15.png)

Ta cÃ³ thá»ƒ tháº¥y, khi táº¡o thÃ¬ 2 file Ä‘á»u cÃ³ dung lÆ°á»£ng lÃ  2G, nhÆ°ng sau Ä‘Ã³, kiá»ƒm tra thá»±c táº¿ thÃ¬ ta tháº¥y file cÃ³ Ä‘á»‹nh dáº¡ng qcow2 chá»‰ cÃ³ dung lÆ°á»£ng lÃ  193K, cÃ²n file Ä‘á»‹nh dáº¡ng raw thÃ¬ váº«n lÃ  2G.

### 3.2 Performance (hiá»‡u nÄƒng)

Äá»ƒ test hiá»‡u nÄƒng giá»¯a 2 Ä‘á»‹nh dáº¡ng nÃ y, sá»­ dá»¥ng cÃ¢u lá»‡nh `dd` Ä‘á»ƒ Ä‘á»c vÃ  ghi dá»¯ liá»‡u tá»« cÃ¡c file trÃªn.

**Äá»c dá»¯ liá»‡u:**

    dd if=file.raw of=test1 bs=8k count=100000
    dd if=file.qcow2 of=test2 bs=8k count=100000

![áº£nh 16](/QuyenNV/14.KVM/images/anh16.png)

Ghi dá»¯ liá»‡u

    dd if=/dev/zero of=file.raw bs=8k count=100000
    dd if=/dev/zero of=file.qcow2 bs=8k count=100000

![áº£nh 17](/QuyenNV/14.KVM/images/anh17.png)

### 3.3 Táº¡o snapshot

Chá»‰ cÃ³ `qcow2` há»— trá»£ táº¡o snapshot

### 3.4 Chuyá»ƒn Ä‘á»•i giá»¯a raw vÃ  qcow2

Chuyá»ƒn tá»« `qcow2` sang `raw` :

    qemu-img convert -f qcow2 -O raw file.qcow2 file.raw

![áº£nh 18](/QuyenNV/14.KVM/images/anh18.png)

Chuyá»ƒn tá»« `raw` sang `qcow2` :

    qemu-img convert -f raw -O qcow2 file.raw file.qcow2

![áº£nh 19](/QuyenNV/14.KVM/images/anh19.png)