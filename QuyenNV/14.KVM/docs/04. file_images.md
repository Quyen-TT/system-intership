# Tìm hiểu các định dạng file images

## 1. Cơ chế lưu trữ Thin-Thick

### 1.1 Thick Provisioning

Thick Provisioning là một phương pháp quản lý dung lượng lưu trữ trong đó một lượng không gian đĩa cố định được cấp phát sẵn cho một ổ đĩa ảo hoặc một tập dữ liệu ngay từ đầu. Dung lượng này được dành riêng cho ổ đĩa đó, bất kể dữ liệu thực tế được lưu trữ là bao nhiêu. 

Có hai biến thể chính của phương pháp này:

- Eager Zeroed Thick Provisioning (Cấp phát dày, ghi số 0 ngay)

    - Kỹ thuật này không chỉ cấp phát không gian lưu trữ trước mà còn ghi số 0 vào toàn bộ vùng dung lượng đã cấp phát ngay lập tức.

    - Việc ghi số 0 này đảm bảo rằng mọi dữ liệu cũ còn sót lại đều bị xóa sạch, tạo ra một "trang trắng" để ghi dữ liệu mới.

    - Điều này đặc biệt quan trọng trong các môi trường yêu cầu tính toàn vẹn và bảo mật dữ liệu cao, vì nó loại bỏ khả năng truy cập vào dữ liệu cũ còn sót lại.

    - Ngoài ra, việc ghi số 0 từ trước còn giúp tăng hiệu năng ghi cho các ứng dụng ghi dữ liệu nhiều, vì không còn phải thực hiện bước làm sạch trong quá trình ghi sau này.

- Lazy Zeroed Thick Provisioning (Cấp phát dày, ghi số 0 khi cần)

    - Ngược lại với eager, lazy zeroed provisioning cũng cấp phát không gian đĩa trước, nhưng không ghi số 0 ngay lập tức.

    - Không gian được đánh dấu là đã cấp phát và sẽ được ghi số 0 khi cần, tức là trong lúc có dữ liệu được ghi vào.

    - Cách này giúp rút ngắn thời gian cấp phát ban đầu, vì nó bỏ qua bước ghi số 0 trước.

    - Tuy nhiên, hiệu năng ghi có thể bị ảnh hưởng lần đầu tiên mỗi vùng đĩa được ghi, vì hệ thống cần phải ghi số 0 trước rồi mới ghi dữ liệu, điều này có thể gây ra độ trễ trong các ứng dụng cần tốc độ ghi cao ngay lập tức.

![ảnh 13](/QuyenNV/14.KVM/images/anh13.png)

### 1.2 Thin Provisioning

Thin Provisioning là một phương pháp cấp phát dung lượng lưu trữ một cách linh hoạt và động, đối lập hoàn toàn với Thick Provisioning. Thay vì cấp phát toàn bộ dung lượng đĩa từ đầu, Thin Provisioning chỉ cấp phát không gian khi thực sự cần thiết để lưu trữ dữ liệu.

Cách tiếp cận này liên quan đến việc tạo ra một vùng lưu trữ ảo (virtual storage pool) mà đối với hệ điều hành và ứng dụng thì có vẻ như có sẵn một khối lượng lớn dung lượng đĩa, dù thực tế không gian vật lý hiện có có thể nhỏ hơn nhiều.

Cơ chế hoạt động:

- Khi nhu cầu lưu trữ dữ liệu tăng lên, Thin Provisioning sẽ cấp phát thêm dung lượng một cách tự động từ vùng lưu trữ chung (storage pool) cho ổ đĩa ảo.

- Việc cấp phát này tiếp tục diễn ra cho đến khi đạt đến giới hạn tối đa đã định nghĩa.

![ảnh 14](/QuyenNV/14.KVM/images/anh14.png)

## 2. Định dạng ổ đĩa ISO, RAW và QCOW2 trong KVM

### 2.1 ISO (International Standards Organization Disk Image)

ISO là một định dạng ảnh đĩa quang tiêu chuẩn, chứa toàn bộ nội dung của một đĩa CD/DVD, bao gồm hệ thống tập tin và dữ liệu nhị phân.

Đặc điểm kỹ thuật:

- Là định dạng chỉ đọc (read-only).

- Không thể ghi thêm dữ liệu vào file ISO.

- Kích thước cố định, phản ánh nội dung bên trong.

- Không thể dùng để khởi động hệ điều hành lâu dài (non-persistent).

Ứng dụng trong KVM:

- Được sử dụng như một đĩa cài đặt hệ điều hành (bootable installation media).

- Thường được gắn vào máy ảo như một ổ DVD ảo để tiến hành cài đặt các hệ điều hành như Ubuntu, CentOS, Windows, v.v.

- Có thể dùng để chứa bộ cài đặt phần mềm chuyên dụng.

### 2.2 RAW (Raw Disk Image)

RAW là định dạng ảnh đĩa đơn giản nhất, ghi dữ liệu nhị phân trực tiếp, không nén, không chứa metadata. File RAW phản ánh đúng cấu trúc và dung lượng của một thiết bị lưu trữ vật lý.

Đặc điểm kỹ thuật:

- Không hỗ trợ snapshot hoặc các tính năng nâng cao.

- Cấp phát dày (thick provisioning): khi tạo file RAW có kích thước 20 GB, nó chiếm đúng 20 GB trên đĩa, ngay cả khi chỉ mới sử dụng 1 GB.

- Tương thích cao với các hệ thống lưu trữ, phần mềm backup và công cụ xử lý block-level.

Ưu điểm:

- Hiệu năng I/O cao, phù hợp với workload nặng.

- Đơn giản, không có chi phí quản lý metadata.

- Phù hợp với các hệ thống lưu trữ cấp thấp như LVM, iSCSI, ZFS,...

Hạn chế:

- Tốn dung lượng lưu trữ, ngay cả khi chưa sử dụng hết.

- Không hỗ trợ các tính năng như snapshot, nén, mã hóa.

Ứng dụng trong KVM:

- Sử dụng trong các môi trường sản xuất (production), nơi hiệu suất và độ tin cậy được ưu tiên hàng đầu.

- Khi tích hợp với các giải pháp lưu trữ vật lý, hệ thống sao lưu block-level hoặc khi dùng chung với container/VM hybrid.

### 2.3 QCOW2 (QEMU Copy-On-Write Version 2)

QCOW2 là định dạng ảnh đĩa tiên tiến do QEMU phát triển, hỗ trợ nhiều tính năng mở rộng nhằm đáp ứng nhu cầu lưu trữ hiện đại cho máy ảo.

Đặc điểm kỹ thuật:

- Hỗ trợ copy-on-write, giúp giữ lại các trạng thái trước đó (cơ sở cho snapshot).

- Thin provisioning: dung lượng file tăng dần theo dữ liệu được ghi thực tế.

Hỗ trợ các tính năng:

- Snapshot (tạo các điểm khôi phục trạng thái máy ảo).

- Nén dữ liệu (compression) để giảm dung lượng lưu trữ.

- Mã hóa (encryption) nhằm tăng cường bảo mật.

- Backing file (tạo file base và các bản ghi đè).

Ưu điểm:

- Linh hoạt, dễ quản lý và tiết kiệm tài nguyên.

- Cho phép sử dụng nhiều snapshot và khôi phục trạng thái hệ thống nhanh chóng.

- Phù hợp trong môi trường phát triển, thử nghiệm, giảng dạy hoặc demo.

Hạn chế:

- Hiệu năng có thể thấp hơn so với RAW do phải xử lý metadata.

- Có nguy cơ phân mảnh nếu sử dụng snapshot nhiều lần và không tối ưu.

Ứng dụng trong KVM:

- Môi trường thử nghiệm, lab ảo hóa, phát triển phần mềm.

- Khi cần khôi phục trạng thái nhanh, quản lý nhiều phiên bản máy ảo, hoặc chia sẻ mẫu cấu hình.

## 3. So sánh RAW với QCOW2

## 🔍 So sánh RAW và QCOW2

| **Tiêu chí**     | **RAW**                                                                 | **QCOW2**                                                                 |
|------------------|-------------------------------------------------------------------------|---------------------------------------------------------------------------|
| **Dung lượng**   | Thick provisioning: chiếm toàn bộ dung lượng ngay khi tạo. | Thin provisioning: dung lượng thực tế tăng dần theo dữ liệu. |
| **Hiệu năng**    | Hiệu năng cao: truy cập trực tiếp không qua lớp metadata trung gian.   | Hiệu năng thấp hơn do xử lý metadata, snapshot, copy-on-write.           |
| **Snapshot**     | Không hỗ trợ snapshot nội tại.                                          | Hỗ trợ snapshot mạnh mẽ, cho phép lưu trạng thái và khôi phục nhanh chóng. |
| **Hỗ trợ nén / mã hóa** | Không hỗ trợ.                                                    | Có hỗ trợ nén và mã hóa nội dung.                                        |
| **Tương thích**  | Tương thích cao với phần mềm/thiết bị quản lý đĩa cấp thấp (LVM, dd...). | Tối ưu cho môi trường ảo hóa sử dụng KVM/QEMU.                           |
| **Ứng dụng phù hợp** | Môi trường sản xuất, yêu cầu hiệu năng cao.                         | Phát triển, thử nghiệm, nhiều snapshot và cần tiết kiệm dung lượng.      |

### 3.1 Dung lượng

Sử dụng câu lệnh `qemu-img` để tạo ra một file có định dạng raw và một file có định dạng qcow2 đều có dung lượng là 2G để tiến hành so sánh.

File raw:

    qemu-img create -f raw file.raw 2G

File qcow2:

    qemu-img create -f qcow2 file.qcow2 2G

![ảnh 15](/QuyenNV/14.KVM/images/anh15.png)

Ta có thể thấy, khi tạo thì 2 file đều có dung lượng là 2G, nhưng sau đó, kiểm tra thực tế thì ta thấy file có định dạng qcow2 chỉ có dung lượng là 193K, còn file định dạng raw thì vẫn là 2G.

### 3.2 Performance (hiệu năng)

Để test hiệu năng giữa 2 định dạng này, sử dụng câu lệnh `dd` để đọc và ghi dữ liệu từ các file trên.

**Đọc dữ liệu:**

    dd if=file.raw of=test1 bs=8k count=100000
    dd if=file.qcow2 of=test2 bs=8k count=100000

![ảnh 16](/QuyenNV/14.KVM/images/anh16.png)

Ghi dữ liệu

    dd if=/dev/zero of=file.raw bs=8k count=100000
    dd if=/dev/zero of=file.qcow2 bs=8k count=100000

![ảnh 17](/QuyenNV/14.KVM/images/anh17.png)

### 3.3 Tạo snapshot

Chỉ có `qcow2` hỗ trợ tạo snapshot

### 3.4 Chuyển đổi giữa raw và qcow2

Chuyển từ `qcow2` sang `raw` :

    qemu-img convert -f qcow2 -O raw file.qcow2 file.raw

![ảnh 18](/QuyenNV/14.KVM/images/anh18.png)

Chuyển từ `raw` sang `qcow2` :

    qemu-img convert -f raw -O qcow2 file.raw file.qcow2

![ảnh 19](/QuyenNV/14.KVM/images/anh19.png)