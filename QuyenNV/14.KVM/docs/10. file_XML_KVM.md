# Tìm hiểu file XML trong KVM và Tạo VM bằng file XML

## 1. Khái niệm về XML

XML (eXtensible Markup Language) là ngôn ngữ đánh dấu mở rộng được thiết kế để lưu trữ và truyền tải dữ liệu một cách có cấu trúc. Tác dụng chính của XML là đơn giản hóa việc chia sẻ dữ liệu giữa các nền tảng và các hệ thống được kết nối thông qua mạng Internet.

## XML trong KVM

Một VM trong KVM có hai thành phần chính:

### 1.1 VM's definition 

Định nghĩa của một máy ảo trong KVM được lưu trữ dưới dạng tập tin XML, và được quản lý bởi `Libvirt` – một lớp trừu tượng để quản lý ảo hóa trong Linux.

Các file XML này thường nằm trong thư mục `/etc/libvirt/qemu/`

File domain XML chứa các thông tin về máy ảo như (số CPU, RAM, các thiết lập của I/O, card mạng,...)

Ngoài file domain XML còn có các file XML khác để lưu thông tin network, storage,...

![ảnh 72](/QuyenNV/14.KVM/images/anh67.png)

### 1.2 VM's storage 

Dữ liệu của máy ảo (tức là đĩa cứng ảo) được lưu trữ dưới dạng file ảnh đĩa (disk image), thường nằm tại thư mục `/var/lib/libvirt/images/`

![ảnh 73](/QuyenNV/14.KVM/images/anh68.png)

## 2. Các thành phần trong file domain XML của VM

Ta có thể dùng lệnh `virsh edit tên_file` để chỉnh sửa (chú ý tên file bỏ phần đuôi .xml) hoặc ta cũng có thể sử dụng vi hoặc vim để chỉnh sủa nó.

![ảnh 74](/QuyenNV/14.KVM/images/anh69.png)

Một số thành phần chính của file XML 

![ảnh 75](/QuyenNV/14.KVM/images/anh70.png)

- name: tên của VM

- uuid: uuid của VM

- metadata: Chứa siêu dữ liệu bổ sung về VM

- memory: dung lượng RAM của VM

- unit='KiB': đơn vị đo dung lượng RAM, có thể sử dụng các đơn vị khác

- currentMemory: dung lượng RAM hiện tại

- vcpu: Số cpu ảo được cài đặt

- os: hệ điều hành đang cài đặt trên máy ảo

Phần `devices`: các thông số của các device trên VM

![ảnh 76](/QuyenNV/14.KVM/images/anh71.png)

- disk: thông tin disk

- source: nơi lưu VM

Mục `interface`: phần card mạng của VM

![ảnh 77](/QuyenNV/14.KVM/images/anh72.png)

- interface type: kiểu card mạng

- mac: địa chỉ MAC của card

- source: tên card

## 3. Tạo 1 VM bằng file domain XML

### 3.1 Chuẩn bị file XML

Chuẩn bị 1 file XML, lưu tại thư mục `/etc/libvirt/qemu/`

    <domain type='kvm'>
    <name>VM2</name>
    <uuid>755c2e6a-735d-11f0-88f1-000c2970fc38</uuid>
    <memory unit='KiB'>524288</memory>
    <currentMemory unit='KiB'>524288</currentMemory>
    <vcpu>1</vcpu>
    <os>
        <type arch='x86_64' machine='pc-q35-rhel9.6.0'>hvm</type>
        <boot dev='cdrom'/>
    </os>
    <features>
        <acpi/>
    </features>
    <clock offset='utc'/>
    <on_poweroff>destroy</on_poweroff>
    <on_reboot>restart</on_reboot>
    <on_crash>destroy</on_crash>
    <devices>
        <emulator>/usr/libexec/qemu-kvm</emulator>
        <controller type='sata' index='0'>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/>
        </controller>
        <disk type="file" device="disk">
        <driver name="qemu" type="qcow2"/>
        <source file="/var/lib/libvirt/images/vm2.qcow2"/>
        <target dev="vda" bus="virtio"/>
        <address type="pci" domain="0x0000" bus="0x00" slot="0x04" function="0x0"/>
        </disk>
        <disk type="file" device="cdrom">
        <driver name="qemu" type="raw"/>
        <source file="/var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-2009.iso"/>
        <target dev="sda" bus="sata"/>
        <readonly/>
        </disk>
        <interface type='bridge'>
        <source bridge='testbr'/>
        </interface>
        <input type='mouse' bus='ps2'/>
        <graphics type='vnc' port='-1' autoport="yes" listen='0.0.0.0'/>
        <console type='pty'>
        <target port='0'/>
        </console>
    </devices>
    </domain>

File domain xml này sẽ tạo ra máy ảo với những thông số sau:

- 512MB RAM, 1 vCPU

- Đường dẫn tới ổ đĩa: /var/lib/libvirt/images/VM2.qcow2

- Máy ảo được boot từ CD-ROM: /var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-2009.iso

- Sử dụng Linux bridge testbr

- Mã uuid, ta có thể download package `uuid` rồi sử dụng lệnh `uuid` để sinh ra 1 mã uuid

![ảnh 78](/QuyenNV/14.KVM/images/anh73.png)

Ngoài ra, ta có thể tạo 1 file xml bằng việc dump từ một máy ảo đang chạy bằng câu lệnh

    virsh dumpxml VM1 > VM2.xml

### 3.2 Tạo ổ đĩa

Dùng câu lệnh:

    qemu-img create -f qcow2 /var/lib/libvirt/images/vm2.qcow2 10G

để tạo ổ đĩa dung lượng 10G với định dang qcow2

![ảnh 79](/QuyenNV/14.KVM/images/anh74.png)

### 3.3 Khởi tạo máy ảo

Dùng câu lệnh virsh create <ten_file_domain>.xml để khởi tạo máy ảo:

![ảnh 80](/QuyenNV/14.KVM/images/anh75.png)

Kiểm tra xem máy ảo đã được tạo hay chưa bằng câu lệnh `virsh list`

![ảnh 81](/QuyenNV/14.KVM/images/anh76.png)

Sử dụng `virt-manager` để quản lí VM

![ảnh 82](/QuyenNV/14.KVM/images/anh77.png)

## 4. Chỉnh sửa cấu hình máy ảo bằng file XML

Trước khi tiến hành chỉnh sửa cấu hình file XML thì sẽ tắt VM trước

Ta dùng lệnh `virsh edit <tên_vm>` hoặc có thể sử dụng vi, vim, nano để edit file .xml của VM.

![ảnh 83](/QuyenNV/14.KVM/images/anh78.png)

Thay đổi dung lượng RAM của VM2 thành 600000 Kib. Sau đó define lại VM2

![ảnh 84](/QuyenNV/14.KVM/images/anh79.png)

Sau đó, start VM2 trở lại và kiểm tra lại dung lượng RAM

![ảnh 85](/QuyenNV/14.KVM/images/anh80.png)

Kiểm tra trên virt-manager

![ảnh 86](/QuyenNV/14.KVM/images/anh81.png)