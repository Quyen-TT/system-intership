# Tìm hiểu file XML network và Tạo Virtual-network bằng file XML

## 1. File XML network

Thư mục chứa file XML network. Các file ở đây là mạng ảo trong KVM

    /etc/libvirt/qemu/networks

![ảnh 87](/QuyenNV/14.KVM/images/anh82.png)

Nội dung file `default.xml`

![ảnh 88](/QuyenNV/14.KVM/images/anh83.png)

- `name`: tên mạng

- `forward mode` : kiểu mạng

- `bridge` : card sử dụng

- `mac` : địa chỉ MAC

- `domain` : tên domain của mạng

- `ip` : thông số IP của mạng

    - `dhcp` : thông tin dhcp của mạng

        - `range` : dải cấp dhcp cho các VM

## 2. Tạo virtual network bằng file XML

### 2.1 Chuẩn bị file XML

Tạo 1 mạng ảo Host-only. Ta tạo file xml `isolated.xml` trong thư mục `/etc/libvirt/qemu/networks/`

    <network>
    <name>isolated.xml</name>
    </network>

### 2.2 Tiến hành tạo mạng bằng file xml

Tiến hành define network từ file xml bằng câu lệnh `virsh net-define isolated.xml`

![ảnh 89](/QuyenNV/14.KVM/images/anh84.png)

Sau khi đã define, sử dụng câu lệnh `virsh net-list --all` để xem network available:

![ảnh 90](/QuyenNV/14.KVM/images/anh85.png)

Mạng isolated đã xuất hiện, tuy nhiên nó vẫn chưa được active.

Sau khi define, libvirt sẽ tự động add thêm một số thành phần vào file xml bạn vừa tạo và lưu nó tại `/etc/libvirt/qemu/networks/`

File `isolated.xml`

![ảnh 91](/QuyenNV/14.KVM/images/anh86.png)

Bạn có thể chỉnh sửa file xml bằng lệnh `virsh net-edit isolated`

File `isolated.xml` sau khi chỉnh sửa

![ảnh 92](/QuyenNV/14.KVM/images/anh87.png)

Bên cạnh đó, bạn cũng có thể dùng lệnh virsh net-dumpxml <net_name> để xem chi tiết cấu hình trong các file network xml của Linux Bridge.

![ảnh 93](/QuyenNV/14.KVM/images/anh88.png)

Sau khi cấu hình xong, ta tiến hành start virtual network vừa tạo bằng câu lệnh `virsh net-start isolated`

![ảnh 94](/QuyenNV/14.KVM/images/anh89.png)

Như vậy, isolated đã được start và có thể sử dụng. Dùng virt-manager để xem:

![ảnh 95](/QuyenNV/14.KVM/images/anh90.png)

### 2.3 Chỉnh sửa cấu hình mạng

Trong trường hợp người dùng muốn thay đổi cấu hình:

- Tiến hành chỉnh sửa trong file xml

- Dùng lệnh virsh net-destroy và virsh net-start để reset lại virtual network.

### 2.4 Ví dụ về file XML các kiểu mạng

#### 2.4.1 NAT

    <network>
    <name>nat</name>
    <bridge name="virbr1"/>
    <forward mode="nat"/>
    <ip address="192.168.123.1" netmask="255.255.255.0">
        <dhcp>
        <range start="192.168.123.128" end="192.168.123.254"/>
        </dhcp>
    </ip>
    </network>

- `<forward mode="nat"/>`: dòng này định nghĩa kiểu mạng là NAT

### 2.4.2 Host-only

    <network>
    <name>hostonly</name>
    <bridge name="virbr2"/>
    <ip address="192.168.125.1" netmask="255.255.255.0">
        <dhcp>
        <range start="192.168.125.128" end="192.168.125.254"/>
        </dhcp>
    </ip>
    </network>

- Với kiểu Host-only sẽ không có thẻ chuyển tiếp `<forward>`

### 2.4.3 Bridge

    <network>
    <name>local</name>
    <bridge name="virbr3"/>
    <forward mode="route" dev="eth1"/>
    <ip address="192.168.127.1" netmask="255.255.255.0">
        <dhcp>
        <range start="192.168.127.128" end="192.168.127.254"/>
        </dhcp>
    </ip>
    </network>
    <forward mode="route" dev="eth1"/> :

- `mode="route"`: kiểu mạng bridge

- `dev="eth1"`: chọn card bridge mà nó gắn vào