# Tìm hiểu Live migrate trên KVM

## 1. Tổng quan
Trong quá trình vận hành để phục vụ cho việc bảo trì và nâng cấp hệ thống chúng ta cần chuyển các VM từ host này sang host khác. Với các VM đang chạy các ứng dụng quan trọng chúng ta không thể tắt nó đi trong quá trình chuyển. Trên KVM việc live migrate sẽ đảm bảo được các yêu cầu này

## 2. Chuẩn bị

Chuẩn bị ba máy cài đặt hệ điều hành Centos 9 trong đó một máy dùng để cài đặt NFS dùng làm máy lưu file disk của VM và 2 máy cài đặt KVM.

Ba máy này cần có card mạng và có thể kết nối được với nhau

Mô hình

![ảnh 95](/QuyenNV/14.KVM/images/NFS.png)

Cơ chế cơ bản của live-migrate:

Về cơ bản cơ chế di chuyển vm khi vm vẫn đang hoạt động. Quá trình trao đổi diễn ra nhanh các phiên làm việc kết nối hầu như không cảm nhận được sự gián đoạn nào. Quá trình Live Migrate được diễn ra như sau:

Bước đầu tiên của quá trình Live Migrate: 1 ảnh chụp ban đầu của VM cần chuyển trên host host1 được chuyển sang VM trên host host2.

Trong trường hợp người dùng đang truy cập VM tại host host1 thì những sự thay đổi và hoạt động trên host host1 vẫn diễn ra bình thường, tuy nhiên những thay đổi này sẽ không được ghi nhận.

Những thay đổi của VM trên host KVM101 được đồng bộ liên tục đến host host2.

Khi đã đồng bộ xong thì VM trên host host1 sẽ offline và các phiên truy cập trên host host1 được chuyển sang host host2.

## 3. Cấu hình 

### 3.1 Cấu hình phân dải tên miền

Để có thể live migrate giữa 2 KVM host thì 2 máy này cần biết tên miền của nhau. Bạn có thể cấu hình dịch vụ DNS phân dải tên miền cho các 2 máy này.

Đây là mô hình lap có ít máy nên tôi sẽ cấu hình luôn trong file `/etc/hosts`

Trên host1

Sửa tên máy trong file `/etc/hostname`. Máy này tôi để tên là host1

    host1

Chỉ ra tên miền và địa chỉ của máy KVM host còn lại trong file `/etc/hosts`. Thêm dòng sau vào cuối file. Chú ý đổi đúng địa chỉ IP máy KVM host còn lại của bạn

    192.168.91.140  host2.local host2

Reboot lại máy

Trên host2

Sửa tên máy trong file `/etc/hostname`. Máy này tôi để tên là host2

    host2

Bổ sung vào file `/etc/hosts` dòng sau. Chú ý thay đổi địa chỉ IP thích hợp

    192.168.91.128  host1.local host1

Reboot lại máy

### 3.2 Cài đặt NFS

#### NFS Server (192.168.91.142)

Chọn 1 thư mục để làm thư mục share hoặc tạo mới 1 thư mục. Ở đây, ta tạo 1 thư mục `/root/storage`

    sudo mkdir -p /root/storage

Chia sẻ thư mực này với các máy KVM host bằng cách ghi các thông tin như sau vào trong file `/etc/exports`

    sudo nano /etc/exports  
    /root/storage 192.168.91.128/24(rw,sync,no_subtree_check,no_root_squash)  
    /root/storage 192.168.91.140/24(rw,sync,no_subtree_check,no_root_squash)  

Địa chỉ IP bên trên là địa chỉ IP của 2 máy KVM host.

Cập nhật lại file vừa chỉnh sửa

    sudo exportfs -ra

#### Trên mỗi KVM Host (192.168.91.128 và 192.168.91.140)

Mount thư mục NFS

    sudo mount 192.168.91.142:/root/storage /var/lib/libvirt/images/

**Lưu ý**: mỗi khi reboot lại máy ta cần mount lại các thư mục này. Nếu không muốn bạn mount nó bằng cách sửa file `/etc/fstab`

### 3.3 Cài đặt KVM

Thực hiện cài đặt KVM trên cả 2 máy KVM host. 

Khi cài đặt VM ta cần lưu file disk của VM vào thư mục đã mount với thư mục được share của NFS server.

Khi cài máy ảo xong ta cần thêm thông tin sau vào trong file xml của VM bằng cách dùng lệnh

    virsh edit <tên-VM>

Thêm vào `cache='none'` để tránh trường hợp migrate bị mất dữ liệu

![ảnh 96](/QuyenNV/14.KVM/images/anh91.png)

Sau đó reboot lại VM.

Các bước này nên thực hiện ngay sau cài VM kể cả bạn chưa có ý định live migrate ngay lúc này bởi vì khi cần migrate có thể thực hiện được luôn mà không cần phải reboot VM khi đã cài các ứng dụng lên.

### 3.4 Kết nối qemu giữa hai KVM host

Để có thể live migrate giữa hai host thì hai host này cần phải kết nối được với nhau. Để làm được việc này ta thực hiện các bước sau ở trên cả hai máy host KVM.

Mở file `/etc/libvirt/libvirtd.conf`

Tìm và chỉnh như sau (bỏ dấu # nếu có):

    listen_tls = 0
    listen_tcp = 1
    tcp_port = "16509"
    listen_addr = "0.0.0.0"
    auth_tcp = "none"

Mở file `/etc/libvirt/virtproxyd.conf`

Nếu đang dùng virtproxyd (trên RHEL 9/CentOS 9 trở lên không còn libvirtd monolithic), ta cần cấu hình giống vậy:

    listen_tls = 0
    listen_tcp = 1
    tcp_port = "16509"
    listen_addr = "0.0.0.0"
    auth_tcp = "none"

Dừng standalone service để tránh conflict:

    sudo systemctl stop virtproxyd.service
    sudo systemctl disable virtproxyd.service

Bật socket:

    sudo systemctl enable virtproxyd-tcp.socket
    sudo systemctl start virtproxyd-tcp.socket

### 3.5 Migrate

Ta kiểm tra VM trên host1, và tạo một số file như hình

![ảnh 97](/QuyenNV/14.KVM/images/anh92.png)

![ảnh 98](/QuyenNV/14.KVM/images/anh93.png)

Trên host2 không có VM nào.

![ảnh 99](/QuyenNV/14.KVM/images/anh94.png)

Trước khi migrate, ta sẽ chạy lệnh ping trên VM1 của host1

![ảnh 100](/QuyenNV/14.KVM/images/anh95.png)

Migrate từ host1 (192.168.91.128) sang host2 (192.168.91.140) Thực hiện câu lệnh trên host1

    virsh migrate --live --unsafe VM1 qemu+tcp://192.168.91.140/system

![ảnh 101](/QuyenNV/14.KVM/images/anh96.png)
Sau khi quá trình hoàn tất, VM1 trên host host1 sẽ ở trạng thái Shutoff và VM1 chuyển sang host host2 ở trạng thái Running.


![ảnh 102](/QuyenNV/14.KVM/images/anh97.png)

Ta mở VM1 ở trên host2 ta thấy lệnh ping 8.8.8.8 vẫn đang chạy

![ảnh 103](/QuyenNV/14.KVM/images/anh98.png)